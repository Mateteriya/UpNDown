# Онлайн-игра: отдельный сервер с WebSocket — кто что делает

Подробная инструкция по запуску онлайн-режима через **отдельный игровой сервер** (Node.js + WebSocket). Разделение обязанностей: **ты** (владелец проекта), **друг** (хостинг/инфраструктура), **я** (реализация в коде).

---

## 1. Архитектура в двух словах

```
[Браузер / PWA]  ←→  [Твой фронт: Vercel/хостинг]   — уже есть
       │
       │  WebSocket (wss://...)
       ▼
[Игровой сервер: Node.js + WebSocket]  — новый сервис на сервере друга
       │
       │  комнаты, очередь ходов, проверка правил
       ▼
[Другие игроки]  — те же браузеры, подключаются к той же комнате
```

- **Фронт** (React, Vite) — как сейчас: меню, лобби, экран игры. Добавится: подключение к WebSocket, отправка/получение ходов и состояния комнаты.
- **Игровой сервер** — отдельное приложение (Node.js в этом плане): комнаты по коду, рассылка состояния игры всем в комнате, проверка правил на сервере. Размещается на сервере друга.
- **Supabase** — по-прежнему только авторизация и профили; игровая логика и реальное время — на игровом сервере.

---

## 2. Что делаю Я (реализация в коде)

| Задача | Описание |
|--------|----------|
| **Игровой сервер (Node.js)** | Отдельная папка/репо `server/` или отдельный репозиторий: Express (или fastify) + WebSocket (ws или socket.io). API: создать комнату, войти по коду, отправить заказ/ход; сервер хранит состояние комнаты и рассылает его всем участникам. Проверка правил (ход в масть, валидный заказ и т.д.) на сервере. |
| **Протокол сообщений** | Формат JSON-сообщений: тип (create_room, join_room, bid, play_card, state_sync и т.д.), payload. Описание протокола — в коде и в этом доке. |
| **Клиентская интеграция** | В твоём репо: хук или контекст для WebSocket, подключение к `wss://...` (URL из переменной окружения). Лобби: «Создать комнату» → запрос к серверу → получение кода → отображение кода и ссылки; «Присоединиться» → ввод кода → подключение к комнате. Экран игры в онлайн-режиме: чтение состояния из сокета, отправка заказа/хода на сервер, отрисовка как сейчас. |
| **Документация** | Описание протокола, примеры сообщений, как запустить сервер локально (`npm run server` или отдельные команды). Обновление этого файла по мере появления деталей. |

Итог с моей стороны: рабочий сервер (можно запускать у себя для теста) + подключённый фронт (лобби и игра по сети). Деплой сервера на машину друга и настройка доступа — не моя часть (см. ниже).

---

## 3. Что делаешь ТЫ (владелец проекта)

| Задача | Описание |
|--------|----------|
| **Доступ к репозиторию** | Друг (или ты с его машины) должен иметь возможность клонировать/получать обновления: либо доступ к твоему репо (GitHub/GitLab и т.д.), либо ты отдаёшь ему архив/образ с сервером (Docker) после того как я сделаю сервер. |
| **Переменные окружения** | На фронте: URL игрового сервера, например `VITE_WS_URL=wss://game.up2down.example.com` (или IP друга для теста). Значение даёт друг после того как поднимет сервер и скажет адрес. Ты добавляешь переменную в Vercel (или куда деплоишь фронт) и в `.env.local` для разработки. |
| **Тестирование** | После того как друг поднимет сервер: зайти в лобби, создать комнату, с другого браузера/телефона присоединиться по коду, сыграть партию. Писать мне о багах или пожеланиях по протоколу/UI. |
| **Домен (по желанию)** | Если хочешь красивый адрес для сокета (например `wss://game.up2down.online`), нужно завести поддомен и передать другую инструкцию другу: куда направлять этот поддомен (на его сервер). Это не обязательно для старта — можно начать с IP и порта. |

Кратко: ты даёшь доступ к коду/артефактам, подставляешь URL сервера в окружение, тестируешь и даёшь обратную связь.

---

## 4. Что делает ДРУГ (хостинг, сервер, сеть)

Друг поднимает **один сервер** (виртуалка или VPS у него в компании/дома). Ниже — что ему нужно сделать по шагам.

### 4.1. Требования к серверу

| Что | Минимум |
|-----|--------|
| ОС | Linux (Ubuntu 22.04 LTS или аналог) |
| Память | 512 MB RAM (для одного процесса Node достаточно) |
| Сеть | Белый IP или доступ из интернета (порт для WebSocket должен быть открыт или проброшен через reverse proxy) |
| Софт | Node.js 18+ (LTS), либо Docker, если будем отдавать образ |

Никакой отдельной БД для первой версии не нужно: состояние комнат хранится в памяти процесса (при перезапуске сервера комнаты пропадут — это нормально для Альфы).

### 4.2. Шаг 1: Установка Node.js (если не через Docker)

```bash
# Пример для Ubuntu/Debian
sudo apt update
sudo apt install -y nodejs npm
node -v   # должно быть v18 или выше
```

Если друг предпочитает Docker — я могу подготовить `Dockerfile` для игрового сервера; тогда ему нужно только установить Docker и запустить контейнер.

### 4.3. Шаг 2: Размещение кода сервера

**Вариант A:** Клонирование твоего репозитория (если сервер лежит в нём, например в папке `server/`).

```bash
git clone https://github.com/<твой-логин>/UpDown.git
cd UpDown/server
npm install --production
```

**Вариант B:** Ты отдаёшь другу архив (zip/tar) папки `server/` после сборки или образ Docker. Друг распаковывает на сервер и запускает по инструкции ниже.

Друг должен знать: **на каком порту слушает приложение** (например 3001 или 8080). Это будет указано в коде и в README сервера.

### 4.4. Шаг 3: Запуск процесса (чтобы сервер не падал после выхода из SSH)

Через **systemd** (рекомендуется):

1. Создать файл (друг создаёт на сервере):

   `/etc/systemd/system/updown-game.service`

   Содержимое (порт и путь к проекту поправить под факт):

   ```ini
   [Unit]
   Description=Up&Down game server
   After=network.target

   [Service]
   Type=simple
   User=www-data
   WorkingDirectory=/opt/updown-game/server
   ExecStart=/usr/bin/node index.js
   Restart=on-failure
   RestartSec=5
   Environment=NODE_ENV=production
   Environment=PORT=3001

   [Install]
   WantedBy=multi-user.target
   ```

2. Включить и запустить:

   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable updown-game
   sudo systemctl start updown-game
   sudo systemctl status updown-game
   ```

Либо через **pm2** (если друг привык к нему):

```bash
cd /path/to/UpDown/server
npm install -g pm2
pm2 start index.js --name updown-game
pm2 save
pm2 startup
```

### 4.5. Шаг 4: Открытие порта в файрволе

Сервер должен принимать входящие на порт, где слушает приложение (например 3001):

```bash
# Пример для ufw (Ubuntu)
sudo ufw allow 3001/tcp
sudo ufw reload
```

Если друг ставит **reverse proxy** (nginx/Caddy) перед Node, то открывают порт 443 (HTTPS), а прокси проксирует на localhost:3001; тогда снаружи открыт только 443.

### 4.6. Шаг 5: Reverse proxy и HTTPS (чтобы был wss://)

Браузер подключается по **WSS** (WebSocket over TLS). Варианты:

**Вариант A: Nginx**

1. Установить nginx и certbot (Let's Encrypt).
2. Настроить виртуальный хост: по определённому поддомену (например `game.up2down.online`) проксировать на `http://127.0.0.1:3001`.
3. Для WebSocket в nginx обязательны заголовки:
   - `Upgrade: websocket`
   - `Connection: Upgrade`
   Пример блока:

   ```nginx
   location / {
     proxy_pass http://127.0.0.1:3001;
     proxy_http_version 1.1;
     proxy_set_header Upgrade $http_upgrade;
     proxy_set_header Connection "Upgrade";
     proxy_set_header Host $host;
     proxy_set_header X-Real-IP $remote_addr;
   }
   ```

4. Выпустить сертификат для этого поддомена и включить HTTPS.

**Вариант B: Caddy**

Caddy сам получает сертификаты. Пример конфига:

```
game.up2down.online {
  reverse_proxy localhost:3001
}
```

После этого фронт подключается к `wss://game.up2down.online` (или как назовёте поддомен).

**Если без домена (только IP):** тогда WSS по IP возможен только с сертификатом для IP или с самоподписанным (браузер будет ругаться — для теста можно, для продакшена лучше поддомен у друга или у тебя).

### 4.7. Что передать тебе после настройки

Друг должен сообщить тебе:

1. **URL для WebSocket** в формате `wss://...` (или `ws://...` для теста без SSL), по которому браузер может подключиться к игровому серверу.
2. (По желанию) Любые ограничения: лимит подключений, нужно ли белый список IP и т.д.

Ты этот URL прописываешь во фронт (переменная окружения) и в инструкции для тестировщиков.

---

## 5. Чеклисты

### Чеклист для ТЕБЯ

- [ ] Решить, как друг будет получать код: репо (доступ по read) или архив/Docker от тебя.
- [ ] После появления кода сервера от меня: проверить локальный запуск (`npm run server` или аналог в папке server).
- [ ] Получить от друга итоговый URL WebSocket.
- [ ] Добавить переменную окружения (например `VITE_WS_URL`) во фронт и в Vercel (или свой хостинг).
- [ ] Пройти сценарий: создать комнату → присоединиться с другого устройства → сыграть партию.
- [ ] При необходимости завести поддомен для игры и передать другу данные для DNS.

### Чеклист для ДРУГА

- [ ] Поднять виртуалку/сервер с Linux, Node.js 18+ (или Docker).
- [ ] Разместить код игрового сервера (клонирование репо или распаковка архива).
- [ ] Установить зависимости и запустить процесс (systemd или pm2).
- [ ] Открыть порт приложения в файрволе (или только 443 при использовании reverse proxy).
- [ ] Настроить reverse proxy (nginx/Caddy) и HTTPS для поддомена.
- [ ] Проверить с твоей стороны: браузер открывает страницу фронта, в лобби создаётся комната, с другого браузера по коду — вход в комнату.
- [ ] Передать тебе финальный URL WebSocket.

### Чеклист для МЕНЯ (реализация)

- [ ] Реализовать игровой сервер (Node.js): комнаты, коды, приём/рассылка состояния, проверка правил.
- [ ] Описать протокол (формат сообщений) в коде и в docs.
- [ ] Интегрировать фронт: WebSocket, лобби (создать/присоединиться), экран игры в онлайн-режиме.
- [ ] Добавить README в папке server с командами запуска и переменными окружения.
- [ ] (Опционально) Dockerfile для сервера, чтобы друг мог запускать контейнером.

---

## 6. Порядок работ (предлагаемый)

1. **Я** делаю сервер и клиентскую интеграцию в твоём репо; в `docs/` и в `server/README.md` описываю, как запустить сервер локально и какой URL ожидается.
2. **Ты** поднимаешь сервер у себя локально (или на тестовой машине), проверяешь создание комнаты и игру вдвоём с двух вкладок/устройств.
3. **Ты** передаёшь другу ссылку на репо (или архив) и этот документ; друг выполняет раздел 4 и чеклист для друга.
4. **Друг** даёт тебе URL WebSocket; ты прописываешь его во фронт и деплое.
5. **Ты** проводишь финальную проверку на проде (фронт на Vercel, сокет на сервере друга).

Если хочешь, следующий шаг с моей стороны — заложить структуру сервера (папка `server/`, протокол, минимальный create_room/join_room) и обновить этот файл ссылками на конкретные файлы и команды. Можешь прислать уточнения: предпочтительный стек (только Node или допустим Go), нужен ли Docker с самого начала, и как друг предпочитает получать код (только git или ещё архив/образ).
