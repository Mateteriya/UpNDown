# Архитектура: аккаунты, результаты, рейтинги

Краткое предложение по эволюции продукта от текущего офлайн-сохранения до профессиональной системы с учётом пользователей, истории партий и рейтингов.

---

## 1. Текущее состояние

- **Сохранение партии**: `src/game/persistence.ts` — одна активная партия в `localStorage` (ключ `updown_game_state`). Восстановление при F5 на экране игры; очистка при выходе в меню и по кнопке «Новая партия».
- **Результаты**: считаются в игре (раздачи, очки), но нигде не накапливаются и не привязываются к «пользователю».
- **Рейтинги**: отсутствуют.

Цель — сохранять результаты, привязывать их к аккаунту и строить рейтинги без ломания текущего UX.

---

## 2. Аккаунты

### 2.1. Поэтапный подход

1. **Анонимный идентификатор (первый шаг)**  
   - При первом заходе генерировать стабильный `anonymousId` (UUID), хранить в `localStorage`.  
   - Все локальные результаты и рейтинг привязывать к этому ID.  
   - Плюсы: без бэкенда можно накапливать статистику на устройстве; позже — привязка к «настоящему» аккаунту.

2. **Явный аккаунт (email / OAuth)**  
   - Регистрация/вход (email+пароль или Google/Apple и т.п.).  
   - Сущности: `User` (id, email/oauth_id, display_name, created_at).  
   - Связка: `anonymousId` → `userId` при первом входе (миграция истории на сервер).

3. **Выход из игры**  
   - «Выход» = очистка текущей партии из localStorage (уже есть) + опционально выход из аккаунта (очистка сессии). Не путать с «Новая партия» (только новая игра, аккаунт остаётся).

### 2.2. Рекомендация

Сначала ввести `anonymousId` и единый слой «текущий игрок» (anonymous или user). Все записи результатов и рейтинга идут от «текущего игрока». Позже подставить реальную авторизацию без смены контрактов в коде.

---

## 3. Хранение результатов

### 3.1. Что сохранять

- **Партия (игровая сессия)**  
  - Кто играл (игроки: человек + ИИ или несколько людей в будущем).  
  - Настройки (правила, кол-во раздач и т.д.).  
  - Итог: победитель, финальные очки по игрокам.

- **Раздачи**  
  - По каждой раздаче: заказы, взятки, очки по игрокам (уже есть структура `DealResult` в коде).

- **Мета**  
  - Время начала/окончания партии, длительность, устройство (опционально).

### 3.2. Схема данных (когда появится бэкенд)

Пример реляционной модели:

- **users** — id, external_id (anonymous или oauth), display_name, created_at.
- **game_sessions** — id, user_id (владелец/инициатор), mode (offline/online), rules_snapshot, started_at, finished_at, status.
- **game_session_players** — session_id, player_slot, user_id (если человек) или bot_type, final_score, is_winner.
- **deal_results** — session_id, deal_index, player_slot, bid, taken, points (повторяем структуру `DealResult` по слотам).

Сейчас те же сущности можно хранить локально: один «игрок» = текущий пользователь (anonymousId), остальные — ИИ. Формат JSON в localStorage (например, отдельный ключ `updown_results` или IndexedDB для больших объёмов).

### 3.3. Момент записи

- При завершении партии (`game-complete`): сохранять итог сессии + все раздачи в «историю» (локальную или API).  
- Текущее сохранение «активной партии» в `persistence.ts` остаётся для восстановления после F5; оно не заменяет «архив результатов».

---

## 4. Рейтинги

### 4.1. Офлайн против ИИ (текущий режим)

- **Локальная статистика**: победы/поражения, средний счёт, кол-во партий.  
- Отображать: «Ваша статистика» (по anonymousId / user).  
- Рейтинг в классическом смысле (сравнение с другими) здесь не обязателен, но можно ввести «уровень» или «очки опыта» по количеству и исходу партий.

### 4.2. Онлайн (будущее)

- **Рейтинг между людьми**: ELO или упрощённый (победа/поражение + сила соперника).  
- Хранить: `user_id`, `rating`, `games_played`, `updated_at`.  
- Обновление после каждой завершённой онлайн-партии.  
- Дополнительно: сезонные рейтинги, лиги, турниры — отдельный слой поверх базового рейтинга.

### 4.3. Единый слой «профиль игрока»

Один объект «профиль» на текущего игрока (anonymous или user):

- Локально: победы/поражения, последние N партий.  
- На сервере: то же + ELO, место в рейтинге, достижения.  
- UI: один экран «Профиль / Рейтинг», данные подставляются из этого слоя.

---

## 5. Эволюция технического стека

### 5.1. Сейчас

- `persistence.ts` — только активная партия (load/save/clear/hasSavedGame).  
- Результаты партий нигде не пишутся.

### 5.2. Следующий шаг (без бэкенда)

- Ввести **anonymousId** (хранить в localStorage).  
- Добавить модуль **результатов** (например, `src/game/results.ts` или `src/storage/results.ts`):  
  - при `game-complete` сохранять срез партии (итоги + раздачи) в локальный массив/IndexedDB;  
  - ключ по `anonymousId` (или по константе «локальный игрок»).  
- Экран «Мои партии» или «Статистика» — чтение из этого хранилища.  
- `persistence.ts` не трогаем: по-прежнему только «текущая партия».

### 5.3. С бэкендом

- **API** (REST или GraphQL): auth, профиль, отправка результата партии, запрос рейтинга и истории.  
- **Бэкенд** (Node/Go/Python и т.д.): регистрация/логин, валидация, сохранение в БД.  
- **БД**: users, game_sessions, deal_results, ratings.  
- Замена: вместо записи результатов в localStorage — вызов API; чтение рейтинга и истории — с сервера.  
- Текущий `persistence.ts` можно оставить для «активной партии» или дублировать её на сервер (восстановление с любого устройства).

### 5.4. Онлайн-игра (дальше)

- Матчмейкинг, комнаты, реальное время (WebSockets или аналог).  
- Результаты партий считаются на сервере или при согласовании между клиентами, рейтинг обновляется централизованно.

---

## 6. Резюме

| Компонент        | Сейчас              | Ближайший шаг                    | Дальше                    |
|------------------|---------------------|-----------------------------------|---------------------------|
| Идентификация    | Нет                 | anonymousId в localStorage        | User, email/OAuth         |
| Активная партия  | persistence.ts      | Без изменений                     | Опционально синк с сервером |
| Результаты       | Не сохраняются      | Локальный архив по anonymousId    | API + БД                  |
| Рейтинги         | Нет                 | Локальная статистика/«уровень»   | ELO, таблица лидеров      |
| Выход / Новая партия | Очистка партии, меню | То же + при выходе из аккаунта — сброс сессии | То же                     |

Так мы сохраняем текущее поведение (восстановление партии при F5, «Новая партия», выход в меню) и создаём фундамент для аккаунтов, истории и рейтингов без резких переделок.
