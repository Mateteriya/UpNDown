# Что сделано и что делать дальше: имя, рейтинги, авторизация, онлайн

## Статус: фундамент «перед авторизацией/онлайном» выполнен (2025)

Чеклист ниже закрыт. Общий план дальнейших шагов — в **[docs/PLAN-DALEE.md](./PLAN-DALEE.md)** (6 шагов: фундамент → мобильная полировка → онлайн → уровни ИИ → архив результатов → турниры/обучение).

---

## Что уже есть (п.1 плана)

- **Профиль игрока:** `getPlayerProfile` / `savePlayerProfile` (displayName + avatarDataUrl + **profileId**), ключ в localStorage.
- **Первый запуск:** при «Офлайн против ИИ» и имени «Вы» открывается модалка «Как к вам обращаться?».
- **Меню «Профиль (имя и фото)»:** смена имени и загрузка аватарки.
- **В игре:** имя и аватар передаются в `GameTable` → `createGame(..., humanName)` и в панели через `PlayerAvatar` + имя.
- **Локальный рейтинг:** привязан к **profileId** (`getLocalRating(profileId)`, `updateLocalRating(..., profileId)`), миграция со старого ключа «на устройство» выполнена.
- **Авторизация:** Supabase (email + OAuth Google/GitHub), синхронизация профиля с таблицей `profiles` при входе.

Итого: **движок имени и аватар в деле; один источник правды для «кто играет» — профиль из persistence; рейтинг и авторизация опираются на него.**

---

## Что было «мелочами» — уже сделано

1. **Имя при загрузке сохранённой партии**  
   При восстановлении из storage в `GameTable` подставляется текущий `playerDisplayName` (из профиля): `players: restored.players.map((p, i) => i === 0 ? { ...p, name: humanName } : p)`.

2. **Ключ рейтинга**  
   Рейтинг привязан к **profileId** (uuid при первом сохранении профиля). При смене имени рейтинг не «разъезжается».

---

## Порядок дальше: два варианта

### Вариант A: Сначала «рейтинг к имени», потом авторизация

- **Сейчас:** привязать локальный рейтинг к текущему профилю (например, ключ `updown_local_rating_${displayName}` или `updown_local_rating_${profileId}`).
- **Потом:** доработать экран «Ваш рейтинг» (история, точность заказов и т.д.), по желанию заложить место под глобальный рейтинг (бэкенд позже).
- **Затем:** авторизация/регистрация (почта или OAuth). После входа «профиль» может остаться локальным и привязываться к аккаунту при первом логине (имя/аватар синхронизировать с сервером).

**Плюс:** рейтинги и «Победитель: …» сразу осмысленные, без переделок после появления аккаунтов.

---

### Вариант B: Сначала авторизация, потом рейтинг и онлайн

- **Сейчас:** экран входа/регистрации (email + пароль или «войти через …»). После входа у вас есть `userId` и, при желании, имя/аватар с сервера.
- **Профиль:** либо «профиль = аккаунт» (имя с сервера), либо оставить локальный профиль и при логине подставлять имя с сервера в `displayName`.
- **Потом:** рейтинг привязать к `userId`; онлайн (лобби, столы) опираться на те же имена/аккаунты.

**Плюс:** раньше появляется «кто в сети», можно сразу проектировать лобби под авторизованных пользователей.

---

## Рекомендация

- **Если хочется быстрее увидеть осмысленные рейтинги и не трогать бэкенд:** делайте **вариант A** (привязка рейтинга к профилю/имени, доработка экрана рейтинга), затем авторизацию.
- **Если приоритет — онлайн и лобби:** логично **вариант B** (сначала авторизация, потом рейтинг и онлайн), но тогда «Ваш рейтинг» до появления бэкенда может остаться «локальная статистика без привязки к аккаунту» или привязываться к устройству.

**Общее правило:** не упустить «один источник правды»: имя/профиль задаётся в одном месте (сейчас — профиль в persistence), все экраны и рейтинг должны опираться на него; при появлении авторизации решите, считается ли «игрок» = аккаунт или локальный профиль, привязанный к аккаунту при логине.

---

## Профессиональный подход (качество без спешки)

**Рекомендуемый порядок — один источник правды, потом расширение:**

1. **Завершить фундамент «игрок»**  
   - Синхронизировать имя при загрузке сохранённой партии с текущим профилем.  
   - Ввести стабильный ключ профиля (`profileId`: uuid при первом сохранении), чтобы при смене имени рейтинг не «разъезжался» (рейтинг привязать к `profileId`, отображаемое имя — из профиля).

2. **Рейтинги**  
   - Привязать локальную статистику к профилю; доработать экран «Ваш рейтинг» (история, точность заказов).  
   - Заложить место под глобальный рейтинг (API позже), не блокируя локальную игру.

3. **Авторизация**  
   - После входа: либо профиль = данные с сервера, либо локальный профиль привязывается к аккаунту (имя/аватар синхронизировать).  
   - Основной канал заявок — почта: поле email, восстановление пароля, уведомления.

4. **Онлайн**  
   - Лобби и столы опираются на идентификатор игрока (локальный профиль или аккаунт); имена уже есть.

Так вы не переделываете рейтинги и онлайны из‑за «поздно подумали про имя», и каждый шаг опирается на уже сделанное.

---

## Производительность и загрузка экрана игры

**Проблема:** после ввода имени экран игры мог долго оставаться пустым (до минуты в тяжёлых условиях), затем интерфейс появлялся и элементы могли «догружаться».

**Причины (глобально):**

- **Тяжёлый экран игры:** один большой компонент `GameTable`, много DOM и стилей; первый рендер после `setState(initialState)` нагружает главный поток.
- **Один бандл:** меню и игра в одном JS-бандле; при переходе в игру парсится и выполняется весь код игры сразу.
- **Предзагрузка картинок:** 16 PNG фигурных карт запускались в `useEffect` при монтировании; сами по себе они асинхронные, но могли конкурировать с первым кадром.

**Что сделано:**

- **Ленивая загрузка экрана игры:** `GameTable` подгружается через `React.lazy()` при переходе на экран игры. Меню грузится быстрее; при первом входе в игру показывается экран «Загрузка игры…» (Suspense), пока чанк подгружается.
- **Предзагрузка чанка при вводе имени:** при нажатии «Офлайн против ИИ» и открытии модалки «Как к вам обращаться?» в фоне вызывается `import('./ui/GameTable')`. К моменту нажатия «Сохранить» чанк часто уже загружен — переход в игру ощущается быстрее.
- **Отложенный старт предзагрузки картинок:** вызов `preloadCardImages()` перенесён в `setTimeout(..., 0)`, чтобы не конкурировать с первым рендером и отрисовкой кадра.

**Для пользователей:** первый вход в игру (особенно первый раз в сессии) может давать короткий экран «Загрузка игры…»; повторные входы и устройства с кэшем будут быстрее. Если на слабых устройствах или в отдельных браузерах задержка остаётся заметной, следующий шаг — разбить первый рендер `GameTable` (например, минимальный «скелетон» стола и панелей, остальное — после первого кадра или по `requestIdleCallback`).

---

## Краткий чеклист перед авторизацией/онлайном — выполнен

- [x] Имя при загрузке сохранённой партии синхронизировать с текущим профилем — **сделано** в `GameTable` при восстановлении из storage.
- [x] Рейтинг привязан к **profileId** (uuid), отображаемое имя — из профиля.
- [x] Авторизация: локальный профиль привязывается к аккаунту; при входе имя/аватар синхронизируются с Supabase (`profiles`).
- [x] Email в UI (вход/регистрация), восстановление пароля — через Supabase; при необходимости уведомления донастроить в Supabase.

**Итог:** фундамент закрыт. Дальше — по [PLAN-DALEE.md](./PLAN-DALEE.md): мобильная проверка/полировка → онлайн (лобби, столы) → уровни ИИ → архив результатов → турниры/обучение.
