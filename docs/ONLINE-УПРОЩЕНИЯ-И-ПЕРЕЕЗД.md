# Что мы упростили (временно) и что обязательно изменить при постоянном сервере

Чтобы не забыть ужесточить настройки и переключить систему при внедрении постоянного сервера. Отмечай пункты по мере выполнения.

---

## 1. Что мы упростили на Supabase (временный вариант)

### 1.1. Политики RLS для таблицы `game_rooms`

| Что упростили | Сейчас (временно) | Как должно быть при «продакшене» на Supabase |
|---------------|-------------------|------------------------------------------------|
| **Чтение комнаты** (SELECT) | Разрешено **любому** авторизованному пользователю (`using (true)`). Политика: `"Authenticated users can read game rooms"`. | Разрешено только **хосту** и **участникам этой комнаты** (проверка: `auth.uid()` совпадает с `host_user_id` или есть в `player_slots` по полю `userId`). |
| **Обновление комнаты** (UPDATE) | Разрешено **любому** авторизованному пользователю (`using (true)` и `with check (true)`). Политика: `"Authenticated users can update game room"`. | Разрешено только **участникам этой комнаты** (или только хост + участники), чтобы нельзя было подделывать состояние игры из другой комнаты. |

**Зачем упростили:** быстрее запустить тест, не отлаживать проверку по JSON `player_slots`.  
**Риск:** любой залогиненный пользователь может читать и менять любую комнату (знает id комнаты или подбирает). Для теста в кругу своих — приемлемо; для открытого запуска — нет.

---

## 2. Что обязательно сделать при переезде на постоянный сервер (друг)

Здесь два сценария: (A) полностью переходим на сервер друга и Supabase для игры больше не используем; (B) Supabase остаётся (например, только профили), но мы перестаём писать в `game_rooms` из приложения.

### 2.1. В коде (фронт + бэкенд)

| Действие | Описание |
|----------|----------|
| **Переключить онлайн-адаптер** | В настройках фронта (переменные окружения) включить использование WebSocket-сервера друга: указать `VITE_WS_URL=wss://...` и отключить использование Supabase для игры (как именно — будет в коде: флаг или отдельная переменная). |
| **Проверить лобби и игру** | Убедиться, что «Создать комнату» и «Присоединиться» ходят на сервер друга, а не в Supabase. Пройти полный сценарий: создание комнаты, вход по коду, партия. |

### 2.2. В Supabase (если таблицу game_rooms оставляем, но не используем для игры)

| Действие | Описание |
|----------|----------|
| **Не трогать или отключить Realtime** | Если больше не подписываемся на `game_rooms` из приложения, можно в Database → Replication выключить Realtime для `game_rooms`, чтобы не тратить лимиты. |
| **Опционально: ужесточить RLS** | Если решишь оставить таблицу для истории/бэкапов и когда-нибудь снова писать в неё — тогда заменить упрощённые политики на строгие (только хост и участники), как в п. 1.1 выше. |

### 2.3. Если захочешь «закрыть» временный вариант на Supabase полностью

| Действие | Описание |
|----------|----------|
| **Выключить Realtime для game_rooms** | Database → Replication → снять галочку Realtime с `game_rooms`. |
| **Удалить или ужесточить политики** | Либо удалить политики чтения/обновления для `game_rooms`, либо заменить их на строгие (только участники и хост). Политику на создание комнаты можно оставить или удалить, если комнаты больше не создаются из приложения. |
| **Таблицу можно не удалять** | Таблицу `game_rooms` можно оставить пустой или с архивом; удалять не обязательно. |

---

## 3. Если остаёмся на Supabase для онлайна (без сервера друга)

Если по какой-то причине постоянным решением станет именно Supabase (без переезда на сервер друга), тогда **обязательно**:

| Действие | Описание |
|----------|----------|
| **Ужесточить политику SELECT** | Удалить политику `"Authenticated users can read game rooms"` и создать новую: читать комнату только если `auth.uid() = host_user_id` или `auth.uid()` присутствует в `player_slots` (проверка по полю `userId` в элементах массива). |
| **Ужесточить политику UPDATE** | Удалить политику `"Authenticated users can update game room"` и создать новую: обновлять комнату только если пользователь — участник этой комнаты (тот же принцип проверки по `player_slots` / host). |

Готовый SQL для строгих политик можно будет добавить в этот файл или в [ONLINE-SUPABASE-ПОШАГОВО.md](./ONLINE-SUPABASE-ПОШАГОВО.md) в раздел «На постоянную работу».

---

## 4. Чеклист при переезде на сервер друга

- [ ] В проекте включено использование WebSocket (URL сервера друга задан в переменных окружения).
- [ ] Создание комнаты и присоединение по коду идут на сервер друга, не в Supabase.
- [ ] Партия проходит полностью через WebSocket (состояние, заказы, ходы).
- [ ] В Supabase для `game_rooms` отключён Realtime (если таблицу не используем для игры).
- [ ] (По желанию) Политики RLS для `game_rooms` ужесточены или отключены, если таблица больше не используется приложением для игры.

---

## 5. Сводка упрощений (одним списком)

- **Чтение game_rooms:** любой авторизованный пользователь.
- **Обновление game_rooms:** любой авторизованный пользователь.

Всё остальное (создание комнаты только с указанием себя как host, структура таблицы, Realtime, триггер `updated_at`) сделано без упрощений и менять при переезде не обязательно — только переключить источник игры на сервер друга и при необходимости ужесточить или отключить политики в Supabase.
